; Contains mode entry points for ascii mode.
; $Id: Mode3,fff,v 1.1.2.4 1999-02-11 01:53:55 ds Exp $

 GET h.ZapHeader
 GET h.Mode0
 GET h.Mode1
 GET h.AlterTxt
 GET h.ModeBits
 GET h.Redraw
 GET h.Cursors

 EXPORT mode_table_3
 EXPORT mode3_author
 EXPORT mode3_char

; IMPORT div_mod

mode3_author FNS ("Dominic Symes")

mode_table_3
 DCD mode_table_3
 DCD mode3_title
 DCD mode3_author
 DCD 0 ;
 DCD 3+emode_BinaryMode+emode_MayBeCloned
 DCD mode0_init
 DCD 0
 DCD mode3_table_end-mode_table_3

 DCD 0				; postload
 DCD 0
 DCD 0
 DCD modes_start
 DCD modes_end
 DCD mode3_width
 DCD mode3_linecol
 DCD mode3_lineoff
 DCD mode1_clnlog;
 DCD mode1_clnphy;
 DCD mode1_clnoff;
 DCD mode1_nextline;
 DCD mode1_minus
 DCD mode1_plus
 DCD mode1_minus
 DCD mode1_plus
 DCD mode1_cminus
 DCD mode1_cplus
 DCD mode3_redrawline
 DCD mode1_redrawlnum
 DCD mode3_char
 DCD mode1_delete
 DCD 0
 DCD 0
 DCD 0
 DCD 0
 DCD mode1_linestart
 DCD mode1_lineend
 DCD mode1_lineend
 DCD mode1_linestart
 DCD mode0_copy
 DCD 0
 DCD 0
 DCD mode1_aligncaret;
 DCD command_primative
 DCD 0
 DCD 0
 DCD 0
 DCD 0			; runandquit
 DCD 0
 DCD 0
 DCD replace_area ; 0
 DCD 0			; selection
 DCD modes_click	; modes_click ; click
 DCD 0			; messages
 DCD 0 ; mode0_setwidth
 DCD 0			; list fns
 DCD 0 ; mode0_prevline
 DCD 0			; Open window
 DCD mode3_interrogate	; Answer all Zap's questions...
mode3_table_end

mode3_title
 FNS ("ASCII")

mode3_width
 STMFD R13!,{R1-R2,R14}
 MOV R0,#-1
 LDRB R1,[R8,#w_format]
 MOV R2,#0
 BL mode_data
 MOV R0,R0,LSL#16
 MOV R0,R0,LSR#16		; bottom 16 bits
 CMP R0,#1
 MOVLT R0,#1
 STR R0,[R8,#w_bpl]
 LDMFD R13!,{R1-R2,PC}

mode3_redrawline
 FNJSR
 LDR R3,[R8,#w_bpl]
 LDR R4,[R8,#w_txtw]
 ADD R4,R6,R4,LSL #1
red_c3_l1
 CMP R7,R10
 BLCS red_overflow
 BVS red_c3_l2
 LDRB R0,[R7],#1
 STRB R0,[R6],#1
 SUBS R3,R3,#1
 MOV R0,#1
 STRB R0,[R4],#1
 BHI red_c3_l1
red_c3_l2
 ADD R11,R11,#1
 FNRTSS				; ret without error

mode3_lineoff
 SUB R0,R1,R0
 MOV R1,#1
 MOV PC,R14

mode3_linecol
 STMFD R13!,{R1-R6,R14}
 MOV R2,#1
 MOV R3,#1
 B modes_linecol

; R4=w_flags R5=num bytes R6=w_format R7=data R8/R9/R10=input caret

mode3_char
 MOV R11,R5
 B insert_chars_at

mode3_interrogate
 CMP R0,#einterrogate_ModeType
 CMPNE R0,#einterrogate_BlockEdit
 CMPNE R0,#einterrogate_AutoIndent
 CMPNE R0,#einterrogate_SpellAsYouType
 MOVEQ R0,#0
 CMPNE R0,#einterrogate_ElaborateSubStyles
 MOVEQ PC,R14
 CMP R0,#einterrogate_PreSetWidth
 BEQ whatwidthplease
 CMP R0,#einterrogate_ConfineH
 CMPNE R0,#einterrogate_ConfineV
 CMPNE R0,#einterrogate_FreeClick
 CMPNE R0,#einterrogate_SmartCursor
 CMPNE R0,#einterrogate_LineSelect
 MOVEQ R0,#0
 MOVEQ PC,R14
 CMP R0,#einterrogate_SoftWrap
 MVNEQ R0,#0
 CMP R0,#einterrogate_WindowWrapWidth
 MOVEQ R0,R1
 MOV PC,R14

whatwidthplease
 MOV R0,R1
 MOV PC,R14

 END
